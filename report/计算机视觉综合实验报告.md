## 计算机视觉综合实验报告

​												3118311071	林之阳

1. #### 手持相机标定与校正

   1.1.  目标
     - 光学透镜具有固有透视失真，是相机畸变的主要部分，桶形畸变和枕形畸变，会使实际物体的直线在图像中产生弯曲，在手持相机模型中表现为径向畸变

     - 切向畸变，这是由于透镜与成像平面不可能绝对平行造成的。这种畸变会造成图像中的某些点看上去的位置会比我们认为的位置要近一些。

     - 修正以上畸变

       <img src='https://docs.opencv.org/trunk/calib_radial.jpg' width="260" align="center">

   

   1.2.  成像过程
     - 要将真实世界中一点$P = \left( {X,Y,Z} \right)$转化为二维图像中一点$p = \left( {u,v} \right)$

     - 从__世界坐标系__到__相机坐标系__到__成像坐标系__到__图像像素坐标系__

       $$
       s\left(\begin{array}{c}\mu\\ \nu \\ 1\end{array}\right) = \left[\begin{array}{ccc}\alpha & 0 &c_x \\ 0 & \beta & c_y \\ 0 & 0 & 1\end{array}\right] \left[\begin{array}{cccc}f&0&0&0\\0&f&0&0\\0&0&1&0\end{array}\right] \left[\begin{array}{cc}R&t\\0^T&1\end{array}\right] \left(\begin{array}{c}X\\Y\\Z\\1\end{array}\right) \\
       = \left[\begin{array}{cccC}f_x&0&c_x&0\\0&f_y&c_y&0\\0&0&1&0\end{array}\right]\left[\begin{array}{cc}R&t\\0^T&1\end{array}\right] \left(\begin{array}{c}X\\Y\\Z\\1\end{array}\right)
       $$

       

     - 其中$K = \left[\begin{array}{ccc}f_x&0&c_x\\0&f_y&c_y\\0&0&1\end{array}\right]$是相机的内参矩阵，$f_x,f_y$为焦距$f$乘以$x,y$方向上单位距离像素个数，$c_x,c_y$为相机图片$x,y$方向上像素的一半
       1.3. 张氏标定法

     - 获取成像平面角点坐标

       采用黑白棋盘标定板作为拍摄对象，寻找棋盘板所在平面$G_1$与相机成像平面$G_2$之间的关系，通过角点检测可以找到棋盘各个角点在图像中的像素位置，又已知每个角点在实际世界空间中的位置关系，依次寻找两平面的单应关系

     - 优化亚像素坐标

       <img src='https://docs.opencv.org/trunk/cornersubpix.png' width="400">

       对于一角点$q$，在其邻域区间内取任一点$p$，向量$\overrightarrow {qp} $一定与当前点$q$所在邻域内$p$点的灰度梯度方向的转置正交，即$\overrightarrow {qp} {\rm{ }} \cdot {\rm{ }}D{I_p}^T = 0$，于是有待最小化的误差式：
       $$
       \epsilon _i = {DI_{p_i}}^T \cdot (q - p_i)
       $$
       其中${DI_p}^T$是p点的梯度方向转置

     - 根据两平面单应关系和内参约束求解相机内参数
       $$
       \left\{
       \begin{array}{l}h_1^TK^{-T}K^{-1}h_2 = 0 \\ h_1^TK^{-T}K^{-1}h_1 = h_2^TK^{-T}K^{-1}h_2 = 1\end{array}
       \right. \Rightarrow \left\{ \begin{array}{l}v_{22}^Tb = 0 \\ v_{11}b = v_{12}b \end{array}\right.
       $$

       $$
       H =\left[\begin{array}{c}h_1&h_2&h_3\end{array}\right]= \lambda K[\begin{array}{c}r_1&r_2&t\end{array}]
       $$

       图像像素坐标系点$p$与棋盘平面坐标系对应点$P$关系为$p = K[R|t]P$，令$H = K[R|t]$，称H为单应矩阵，即就是两个平面对应点的坐标变换关系。最后根据等式求解得到相机各个内参数

   1.4.  实验环节

   <img src='.\pic\chessBoard.png' width="360" align="center">

     

     - 通过预先输入棋盘内角点规格$6\times8$，通过角点检测找到图像上二维像素坐标，并人为规定棋盘所在三维平面，但保证角点间关系不变，实验中以棋盘平面为$x,y$轴所在平面，单位为棋盘一格

       ```python
       #棋盘坐标 每帧图片共6x8=48个角点坐标
       obj_points
       Out[3]: 
       [array([[0., 0., 0.],
               [1., 0., 0.],
               [2., 0., 0.],
               [3., 0., 0.],
               [4., 0., 0.],
               [5., 0., 0.],
               [6., 0., 0.],
               [7., 0., 0.],
               [0., 1., 0.],
               [1., 1., 0.],...
       
       #像素坐标
       img_points
       Out[4]: 
       [array([[[ 387.3338 ,  619.6611 ]],
               [[ 437.60806,  634.4014 ]],
               [[ 490.82437,  649.5558 ]],
               [[ 546.5159 ,  665.54254]],
               [[ 604.10645,  682.2551 ]],
               [[ 664.7508 ,  699.7915 ]],
               [[ 728.5448 ,  718.77496]],
               [[ 797.99634,  737.1094 ]],
               [[ 390.9601 ,  683.7071 ]],
               [[ 440.52267,  699.3147 ]],
               [[ 491.81396,  715.7705 ]],...
       ```

     - 以多张相机对棋盘格拍摄的两坐标系下点坐标为输入，通过标定算法得到

       相机内参矩阵$camera matrix = \left[\begin{array}{ccc}f_x&0&c_x\\0&f_y&c_y\\0&0&1\end{array}\right]$

       失真系数$Distortion \; coefficients=(k_1 \hspace{10pt} k_2 \hspace{10pt} p_1 \hspace{10pt} p_2 \hspace{10pt} k_3)$

       ```python
       #焦距的单位为棋盘格单位
       camera_matrix 
       Out[15]: 
       array([[1535,    0,  542],
              [   0, 1531,  946],
              [   0,    0,    1]], dtype=int64)
       
       distortion_coefficients
       Out[36]: 
       array([[ 4.78400493e-01, -3.93780904e+00, -3.03638428e-03,
                1.73049372e-03,  1.09382378e+01]])
       ```

     - 径向畸变的产生式为
       $$
       x_{distorted} = x( 1 + k_1 r^2 + k_2 r^4 + k_3 r^6) \\ y_{distorted} = y( 1 + k_1 r^2 + k_2 r^4 + k_3 r^6)
       $$
       切向畸变的产生式为
       $$
       x_{distorted} = x + [ 2p_1xy + p_2(r^2+2x^2)] \\ y_{distorted} = y + [ p_1(r^2+ 2y^2)+ 2p_2xy]
       $$

     - 遵从如上二式，以相机内参和失真系数对拍摄的某张棋盘格照片进行校正

   1.5.  结果分析

   <img src='.\pic\fixed_line.png' width="360" align="center">

   ​                                                                           已修正图图像

   <img src='./pic/ori_line.jpg' height='400px'>

   ​                                                                               原始图像

   通过红色线标识可以观察到原始图像中标定纸中垂直方向上的直线因畸变而产生部分弯曲，而修正后图像则在水平和垂直方向上都保持了直线


2. #### 光流估计方法

   2.1.  目标

   - 在一段连续的图像中，由于摄像机的移动或所拍摄物体的移动，连续帧间某一图像对象的位移变化称为光流

     <img src="https://docs.opencv.org/4.0.0-beta/optical_flow_basic1.jpg" width="260">

     光流的成立基于假设：

     - 连续帧间同一目标对象所在像素的灰度值不变或变化很小
     - 相邻元素具有相同的运动

     第一帧图像中的某对象的像素$I_1(x,y)$在时间$dt$后移动到第二帧图像的$I_2(x+dx,y+dy)$像素上，根据像素灰度不变的假设，有：
     $$
     I(x,y,t) = I(x+dx, y+dy, t+dt)
     $$
     对等号右侧进行泰勒级数展开，消去相同项，两边都除以$ dt$，得到如下方程：
     $$
     \begin{array}{l}
     {f_x}u + {f_y}v + {f_t} = 0\;\\
     \left\{ \begin{array}{l}
     {f_x} = \frac{{\partial f}}{{\partial x}}\;;\;{f_y} = \frac{{\partial f}}{{\partial y}}\\
     u = \frac{{dx}}{{dt}}\;;\;v = \frac{{dy}}{{dt}}
     \end{array} \right.
     \end{array}
     $$
     对该光流方程，其中$f_x$和$f_y$是图像梯度，同样$f_t$是时间方向的梯度。其中$(u,v)$是待求解的像素光流方向，而由于有两个未知数，仅通过一点构成的方程无法求解。故需要LK等方法解决问题

   - 在一段视频中通过光流估计方法追踪某一图像对象。

   2.2.  Lucas-Kanade法

   - 因相邻元素具有相似运动的特性，Lucas-Kanade法根据图像某一对象的区域$3\times3$像素的9个点具有相同运动的前提，得到这9个点的光流方程，而又有这9个点共享同一运动，可以组成含2个未知数9个等式的方程组，由于估计含有偏差，而且约束条件多于求解对象，故采用最小二乘法拟合参数。
     $$
     \begin{bmatrix} u \\ v \end{bmatrix} = \begin{bmatrix} \sum_{i}{f_{x_i}}^2 & \sum_{i}{f_{x_i} f_{y_i} } \\ \sum_{i}{f_{x_i} f_{y_i}} & \sum_{i}{f_{y_i}}^2 \end{bmatrix}^{-1} \begin{bmatrix} - \sum_{i}{f_{x_i} f_{t_i}} \\ - \sum_{i}{f_{y_i} f_{t_i}} \end{bmatrix}
     $$
     
   2.3.  Horn-Schunck法

   - H-S法倾向于认为图像间的运动平滑，即就是让图像中的运动扭曲最小化，给出最平滑的结果。于是光流估计问题可以转化为如下全局扭曲能量的最小化问题：

     $$
     E = \iint \left[（I_{x} u + I_{y}v +I_{t}）^{2} +\alpha^{2}（\lVert\nabla u \rVert ^ {2} + \lVert \nabla v \rVert ^ {2}）\right] {{{\rm{d}}} x {{\rm {d}}} y}
     $$

   - 其中$I_x,I_y,I_t$是图像灰度在$x,y$和时间上的梯度，通过求解多维拉格朗日方程可以最小化该函数，即就是使：
     $$
     {\frac {\partial L} {\partial u}}  -  {\frac {\partial} {\partial x}} {\frac {\partial L} {\partial u_{x}}}  -  {\frac { \partial} {\partial y}} {\frac {\partial L} {\partial u_ {y}}} = 0\\{\frac {\partial L} {\partial v}}  -  {\frac {\partial} {\partial x}} {\frac {\partial L} {\partial v_ {x}}}  -  {\frac { \partial} {\partial y}} {\frac {\partial L} {\partial v_ {y}}} = 0\\其中L为全局扭曲能量的积分
     $$
     通过迭代完成对光流的估计。

   2.4.  实验环节

   - 实际在完成对图像一个区域进行跟踪的操作中，先提取出一部分特征角点，作为光流起始追踪点

     <img src="./pic/CornerPoint.png">

   - 然后通过光流估计法，在下一帧相邻图像中，在距离阈值范围内，寻找可靠临近点，并逐步更新特征角点位置，最后通过选取跟踪成功的点，估计物体在视频流中的运动轨迹

     <img src="D:/workSpace_PY/Camera_Calibrate/report/pic/optiFlow.png">

     ```python
      #初始特征角点位置
      ori_corners
      Out[3]: 
      array([[[ 65.80641 , 349.1025  ]],
             [[ 74.22933 , 279.04092 ]],
             [[ 61.41876 , 196.08736 ]],
             [[768.      ,  13.      ]],
             [[646.95703 , 123.981384]],
             [[555.      , 244.00003 ]],
             [[390.00357 , 240.99562 ]],
             [[807.      ,  24.      ]],
             [[502.00232 , 245.00471 ]]],...
      #相邻下一帧特征角点位置
      curr_corners
      Out[4]: 
      array([[[ 65.76564 , 349.14044 ]],
             [[ 74.24793 , 279.04755 ]],
             [[ 61.41005 , 196.09247 ]],
             [[767.98566 ,  13.006105]],
             [[646.9267  , 123.99193 ]],
             [[554.98694 , 243.9892  ]],
             [[390.00827 , 240.99213 ]],
             [[806.99896 ,  23.995987]],
             [[501.9852  , 244.99893 ]],...
      #帧间特征角点位移
      optiFlow
      Out[17]: 
      array([[[-4.07714844e-02,  3.79333496e-02]],
             [[ 1.86004639e-02,  6.62231445e-03]],
             [[-8.70895386e-03,  5.11169434e-03]],
             [[-1.43432617e-02,  6.10542297e-03]],
             [[-3.03344727e-02,  1.05438232e-02]],
             [[-1.30615234e-02, -1.08337402e-02]],
             [[ 4.69970703e-03, -3.49426270e-03]],
             [[-1.03759766e-03, -4.01306152e-03]],
             [[-1.71203613e-02, -5.78308105e-03]],...
     ```
   qq

3. #### 1

4. #### 1

