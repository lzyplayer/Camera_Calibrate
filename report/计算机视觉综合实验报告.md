## 计算机视觉综合实验报告

​												3118311071	林之阳

1. #### 手持相机标定与校正

   - 目标
     - 光学透镜具有固有透视失真，在手持相机模型中表现为径向畸变
     - 切向畸变，这是由于透镜与成像平面不可能绝对平行造成的。这种畸变会造成图像中的某些点看上去的位置会比我们认为的位置要近一些
     - 修正以上畸变

   ![calib_radial.jpg](https://docs.opencv.org/trunk/calib_radial.jpg) 

   - 成像过程
     - 要将真实世界中一点$P = \left( {X,Y,Z} \right)$转化为二维图像中一点$p = \left( {u,v} \right)$

     - 从__世界坐标系__到__相机坐标系__到__成像坐标系__到__图像像素坐标系__

     - $$
       s\left(\begin{array}{c}\mu\\ \nu \\ 1\end{array}\right) = \left[\begin{array}{ccc}\alpha & 0 &c_x \\ 0 & \beta & c_y \\ 0 & 0 & 1\end{array}\right] \left[\begin{array}{cccc}f&0&0&0\\0&f&0&0\\0&0&1&0\end{array}\right] \left[\begin{array}{cc}R&t\\0^T&1\end{array}\right] \left(\begin{array}{c}X\\Y\\Z\\1\end{array}\right) \\
       = \left[\begin{array}{cccC}f_x&0&c_x&0\\0&f_y&c_y&0\\0&0&1&0\end{array}\right]\left[\begin{array}{cc}R&t\\0^T&1\end{array}\right] \left(\begin{array}{c}X\\Y\\Z\\1\end{array}\right)
       $$

       

     - 其中$K = \left[\begin{array}{ccc}f_x&0&c_x\\0&f_y&c_y\\0&0&1\end{array}\right]$是相机的内参矩阵，$f_x,f_y$为焦距$f$乘以$x,y$方向上单位距离像素个数，$c_x,c_y$为相机图片$x,y$方向上像素的一半
   - 张氏标定法
     - 获取成像平面角点坐标

       采用黑白棋盘标定板作为拍摄对象，寻找棋盘板所在平面$G_1$与相机成像平面$G_2$之间的关系，通过角点检测可以找到棋盘各个角点在图像中的像素位置，又已知每个角点在实际世界空间中的位置关系，依次寻找两平面的单应关系

     - 优化亚像素坐标

       <img src='https://docs.opencv.org/trunk/cornersubpix.png'>

       对于一角点$q$，在其邻域区间内取任一点$p$，向量$\overrightarrow {qp} $一定与当前点$q$所在邻域内$p$点的灰度梯度方向的转置正交，即$\overrightarrow {qp} {\rm{ }} \cdot {\rm{ }}D{I_p}^T = 0$，于是有待最小化的误差式：
       $$
       \epsilon _i = {DI_{p_i}}^T \cdot (q - p_i)
       $$
       其中${DI_p}^T$是p点的梯度方向转置

     - 根据两平面单应关系和内参约束求解相机内参数
       $$
       \left\{
       \begin{array}{l}h_1^TK^{-T}K^{-1}h_2 = 0 \\ h_1^TK^{-T}K^{-1}h_1 = h_2^TK^{-T}K^{-1}h_2 = 1\end{array}
       \right. \Rightarrow \left\{ \begin{array}{l}v_{22}^Tb = 0 \\ v_{11}b = v_{12}b \end{array}\right.
       $$

       $$
       H =\left[\begin{array}{c}h_1&h_2&h_3\end{array}\right]= \lambda K[\begin{array}{c}r_1&r_2&t\end{array}]
       $$

       图像像素坐标系点$p$与棋盘平面坐标系对应点$P$关系为$p = K[R|t]P$，令$H = K[R|t]$，称H为单应矩阵，即就是两个平面对应点的坐标变换关系。最后根据等式求解得到相机各个内参数

   - 实验环节

     <img src='.\pic\chessBoard.png' width="600">

     

     - 通过预先输入棋盘内角点规格$6\times8$，通过角点检测找到图像上二维像素坐标，并人为规定棋盘所在三维平面，但保证角点间关系不变，实验中以棋盘平面为$x,y$轴所在平面，单位为棋盘一格

       ```python
       #棋盘坐标 每帧图片共6x8=48个角点坐标
       obj_points
       Out[3]: 
       [array([[0., 0., 0.],
               [1., 0., 0.],
               [2., 0., 0.],
               [3., 0., 0.],
               [4., 0., 0.],
               [5., 0., 0.],
               [6., 0., 0.],
               [7., 0., 0.],
               [0., 1., 0.],
               [1., 1., 0.],...
       
       #像素坐标
       img_points
       Out[4]: 
       [array([[[ 387.3338 ,  619.6611 ]],
               [[ 437.60806,  634.4014 ]],
               [[ 490.82437,  649.5558 ]],
               [[ 546.5159 ,  665.54254]],
               [[ 604.10645,  682.2551 ]],
               [[ 664.7508 ,  699.7915 ]],
               [[ 728.5448 ,  718.77496]],
               [[ 797.99634,  737.1094 ]],
               [[ 390.9601 ,  683.7071 ]],
               [[ 440.52267,  699.3147 ]],
               [[ 491.81396,  715.7705 ]],...
       ```


2. #### null